#!/bin/bash
set -eu
cd "$(git rev-parse --show-toplevel)"

if command -v nix >/dev/null 2>&1
then
    export NIX_PATH="nixpkgs=$PWD/nix/nixpkgs.nix"
    nix build --file nix --out-link .ghc ghc
fi

cabal_opts=(
    --builddir="$PWD/_out/cabal" 
    --installdir="$PWD/_out/bin"
)

if [ -n "${JENKINS_URL:-}" ]
then
    cabal_opts+=(
        --enable-optimization
    )
fi

exec cabal "${cabal_opts[@]}" "$@"