#!/bin/bash
set -eu
cd "$(git rev-parse --show-toplevel)"

if command -v nix >/dev/null 2>&1
then
    export NIX_PATH="nixpkgs=$PWD/nix/nixpkgs.nix"
    nix build --file nix --out-link .ghc ghc
fi

ghc_version="$(ghc --numeric-version)"

cabal_cmd="${1}" || {
    echo 'A cabal command was not provided' >&2
    exit 1
}
shift

cabal_opts=( 
    --builddir="$PWD/_out/cabal" 
    --package-db=clear
    --package-db="$PWD/.ghc/lib/ghc-${ghc_version}/package.conf.d"
)

case cabal_cmd in
    install)
        cabal_opts+=( --installdir="$PWD/_out/bin" )
esac

if [ -n "${JENKINS_URL:-}" ]
then
    cabal_opts+=(
        --enable-optimization
    )
fi

exec cabal "$cabal_cmd" "${cabal_opts[@]}" "$@"
