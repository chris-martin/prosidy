<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE language SYSTEM "language.dtd" [
  <!ENTITY key "\w[^\s\\\[\]#{}:=,]*">
]>
<language name="Prosidy" section="Sources" extensions="*.pro;*.psh" author="James Alexander Feldman-Crough" license="MPL-2.0" kateversion="3.4" version="1">
  <highlighting>
    <contexts>
      <context name="Main" attribute="Normal" lineEndContext="#stay">
        <Detect2Chars char="#" char1="!" attribute="Hashbang" context="Comment Text" />
        <StringDetect String="---" attribute="Divider" beginRegion="body" context="Body" />
        <RegExpr String="&key;" attribute="Key" context="Header Metadata" firstNonSpace="true" />
        <Detect2Chars char="#" char1="#" attribute="Comment" context="Comment Text" />
        <DetectSpaces />
      </context>

      <context name="Comment Text" attribute="Comment" lineEndContext="#pop" />

      <context name="Body" attribute="Normal" lineEndContext="#stay">
        <DetectSpaces />
        <Detect2Chars char="#" char1="-" attribute="Sigil" context="Block Tag" />
        <Detect2Chars char="#" char1="=" attribute="Sigil" context="Literal Tag" />
        <RegExpr String="(?!#[#:-=])." context="Paragraph" lookAhead="true" />
        <Detect2Chars char="#" char1="#" attribute="Comment" context="Comment Text" />
      </context>

      <context name="Comment" attribute="Comment" lineEndContext="#pop" />

      <context name="Header Metadata" attribute="String" lineEndContext="#pop">
        <DetectChar char=":" attribute="Assignment" />
        <DetectChar char="=" attribute="Assignment" />
      </context>

      <context name="Block Tag" attribute="Normal" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop">
        <RegExpr String="&key;" attribute="Tag" />
        <DetectChar char="[" attribute="Group" context="Tag Metadata" />
        <DetectChar char="{" attribute="Group" context="Inline Tag Body" />
        <DetectChar char=":" attribute="Sigil" context="Block Tag Body" />
      </context>

      <context name="Block Tag Body" attribute="Normal" lineEndContext="#stay">
        <Detect2Chars char="#" char1=":" attribute="Sigil" context="#pop" />
        <IncludeRules context="Body" />
      </context>

      <context name="Inline Tag" attribute="Normal" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop">
        <RegExpr String="&key;" attribute="Tag" />
        <DetectChar char="[" attribute="Group" context="Tag Metadata" />
        <DetectChar char="{" attribute="Group" context="Inline Tag Body" />
      </context>

      <context name="Inline Tag Body" attribute="Normal" lineEndContext="#stay">
        <DetectChar char="}" attribute="Group" context="#pop" />
        <IncludeRules context="Paragraph" />
        <IncludeRules context="Comment" />
      </context>

      <context name="Literal Tag" attribute="Normal" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop">
        <RegExpr String="&key;" attribute="Tag" />
        <DetectChar char="[" attribute="Group" context="Tag Metadata" />
        <DetectChar char=":" attribute="Group" context="Literal Tag Body" />
      </context>

      <context name="Literal Tag Body" attribute="Literal" lineEndContext="#stay">
        <Detect2Chars char="#" char1=":" attribute="Sigil" context="pop" />
      </context>

      <context name="Tag Metadata" attribute="Normal" lineEndContext="#stay">
        <RegExpr String="&key;" attribute="Key" context="Tag Metadata Value" />
        <DetectChar char=']' attribute="Group" context="#pop" />
        <DetectChar char=',' attribute="Group" />
        <Detect2Chars char="#" char1="#" attribute="Comment" context="Comment Text" />
        <DetectSpaces />
      </context>

      <context name="Tag Metadata Value" attribute="Normal" lineEndContext="#stay" fallthrough="true" fallthroughContext="#pop">
        <DetectChar char="=" attribute="Assignment" />
        <DetectChar char=":" attribute="Assignment" />
        <DetectChar char="'" attribute="String" context="Single Quoted Value" />
        <DetectChar char="&quot;" attribute="String" context="Double Quoted Value" />
        <DetectSpaces />
      </context>

      <context name="Paragraph" attribute="Normal" lineEndContext="#pop">
        <DetectChar char="}" lookAhead="true" context="#pop" />
        <Detect2Chars char="#" char1="=" lookAhead="true" context="#pop" />
        <Detect2Chars char="#" char1="-" lookAhead="true" context="#pop" />
        <Detect2Chars char="#" char1="#" lookAhead="true" context="#pop" />
        <RegExpr String="\S" lookAhead="true" context="Paragraph Line" />
      </context>

      <context name="Paragraph Line" attribute="Normal" lineEndContext="#pop">
        <Detect2Chars char="#" char1="#" attribute="Comment" context="Comment Text" />
        <DetectChar char="#" attribute="Sigil" context="Inline Tag" />
        <DetectChar char="}" lookAhead="true" context="#pop" />
      </context>

      <context name="Single Quoted Value" attribute="String" lineEndContext="#stay">
        <DetectChar char="'" attribute="String" context="#pop" />
      </context>

      <context name="Double Quoted Value" attribute="String" lineEndContext="#stay">
        <DetectChar char="&quot;" attribute="String" context="#pop" />
      </context>

      <context name="Error" attribute="Error" lineEndContext="#stay" />
    </contexts>
    <itemDatas>
      <itemData name="Assignment" defStyleNum="dsOperator" />
      <itemData name="Comment"    defStyleNum="dsComment" />
      <itemData name="Divider"    defStyleNum="dsRegionMarker" />
      <itemData name="Error"      defStyleNum="dsError" />
      <itemData name="Group"      defStyleNum="dsOthers" />
      <itemData name="HashBang"   defStyleNum="dsSpecialString" />
      <itemData name="Sigil"      defStyleNum="dsRegionMarker" />
      <itemData name="String"     defStyleNum="dsString" />
      <itemData name="Tag"        defStyleNum="dsAnnotation" />
      <itemData name="Key"        defStyleNum="dsAttribute" />
    </itemDatas>
  </highlighting>
  <general>
    <comments>
      <comment name="singleLine" start="##" />
    </comments>
  </general>
</language>
